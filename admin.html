<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediTrack - Hospital Status Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, addDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const state = {
            user: null,
            activeTab: 'dashboard',
            hospitals: [],
            logs: [],
            systemLogs: [], 
            mappings: [], 
            loading: true,
            simText: '',
            error: null
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAuO1PsUAsMf0OsaK78P9pnnnfHDUXB3bE",
            authDomain: "hospital-tracker-e0e23.firebaseapp.com",
            projectId: "hospital-tracker-e0e23",
            storageBucket: "hospital-tracker-e0e23.firebasestorage.app",
            messagingSenderId: "71333986582",
            appId: "1:71333986582:web:b9d1539554138752199037",
            measurementId: "G-7HP9NE801M"
        };
        
        const appId = 'default-app-id'; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                state.error = "Authentication failed. Check your API key.";
                render();
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) setupListeners();
            else {
                state.loading = false;
                render();
            }
        });

        function setupListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'hospitals'), (snapshot) => {
                state.hospitals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.loading = false;
                if (state.error && state.error.includes("Rules")) state.error = null;
                render();
            }, (error) => handlePermissionError(error));

            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'hospital_logs');
            onSnapshot(query(logsRef, orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            const sysLogsRef = collection(db, 'artifacts', appId, 'public', 'data', 'system_logs');
            onSnapshot(query(sysLogsRef, orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                state.systemLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            const mapRef = collection(db, 'artifacts', appId, 'public', 'data', 'config_mappings');
            onSnapshot(mapRef, (snapshot) => {
                state.mappings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        function handlePermissionError(error) {
            console.error(error);
            if (error.code === 'permission-denied') {
                state.error = "Permission Denied: Ensure Firestore Rules allow public read/write.";
                state.loading = false;
                render();
            }
        }

        window.deleteHospital = async (id) => {
            if(!state.user) return;
            if(confirm('Stop tracking this hospital?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hospitals', id));
            }
        };
        
        window.deleteMapping = async (id) => {
            if(!state.user) return;
            if(confirm('Remove this keyword rule?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_mappings', id));
            }
        };

        window.addMapping = async () => {
             const keyword = document.getElementById('new-keyword').value.trim();
             const name = document.getElementById('new-name').value.trim();
             const addToDash = document.getElementById('add-to-dash').checked;

             if(!keyword || !name) return alert("Please enter both a keyword and a name");
             
             // 1. Create the rule
             await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'config_mappings'), {
                 keyword: keyword.toLowerCase(),
                 displayName: name,
                 timestamp: serverTimestamp()
             });

             // 2. Optionally create the dashboard card immediately
             if(addToDash) {
                 const hospitalId = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hospitals', hospitalId), {
                    name: name,
                    status: 'Normal', // Default state
                    lastUpdated: serverTimestamp()
                 }, { merge: true });
             }

             document.getElementById('new-keyword').value = '';
             document.getElementById('new-name').value = '';
        };

        window.setTab = (tabName) => {
            state.activeTab = tabName;
            render();
        };

        window.setSimText = (text) => {
            document.getElementById('sim-textarea').value = text;
        }

        window.processEmail = async () => {
            const text = document.getElementById('sim-textarea').value;
            if (!text || !state.user) return;
            const btn = document.getElementById('process-btn');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processing...`;
            lucide.createIcons();

            const lowerText = text.toLowerCase();
            let detectedStatus = 'Unknown';
            let hospitalName = 'Unknown Hospital';
            
            // Extract Reason and Comments
            let reason = '';
            let comments = '';
            const reasonMatch = text.match(/reasons?:\s*(.*?)(?:[\r\n]|$)/i);
            if(reasonMatch && reasonMatch[1]) reason = reasonMatch[1].trim().toUpperCase();
            
            const commentMatch = text.match(/(?:comments|comment):\s*(.*?)(?:[\r\n]|$)/i);
            if(commentMatch && commentMatch[1]) comments = commentMatch[1].trim().toUpperCase();

            // Status Logic
            if (lowerText.includes('to normal') || lowerText.includes('status: normal')) {
                detectedStatus = 'Normal';
            } else if (lowerText.includes('to limited divert') || lowerText.includes('to diversion') || lowerText.includes('to full') || lowerText.includes('to divert')) {
                detectedStatus = 'Diversion';
            } else if (lowerText.includes('diversion') || lowerText.includes('divert') || lowerText.includes('full capacity')) {
                detectedStatus = 'Diversion';
            } else if (lowerText.includes('normal') || lowerText.includes('open') || lowerText.includes('clear')) {
                detectedStatus = 'Normal';
            }

            if (detectedStatus === 'Normal') {
                reason = '';
                comments = '';
            }

            // --- NEW NAME LOGIC: USE 2ND LINE ---
            const lines = text.split('\n');
            let rawNameLine = '';
            // Arrays are 0-indexed, so index 1 is the 2nd line
            if (lines.length >= 2) {
                rawNameLine = lines[1].trim();
            }

            // Check if we have a mapping/rule for this line, otherwise use the line itself
            if (state.mappings.length > 0 && rawNameLine) {
                const found = state.mappings.find(m => rawNameLine.toLowerCase().includes(m.keyword.toLowerCase()));
                if (found) hospitalName = found.displayName;
                else hospitalName = rawNameLine;
            } else if (rawNameLine) {
                hospitalName = rawNameLine;
            } else {
                // Fallback if email is only 1 line long
                const commonNames = ['General Hospital', 'Memorial Medical Center', 'City Health', 'St. Marys', 'University Hospital'];
                const foundName = commonNames.find(n => lowerText.includes(n.toLowerCase()));
                if(foundName) hospitalName = foundName;
            }

            if (detectedStatus !== 'Unknown') {
                if(hospitalName === 'Unknown Hospital') hospitalName = "Unknown (Check Email Format)";
                
                const hospitalId = hospitalName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'hospitals', hospitalId), {
                        name: hospitalName,
                        status: detectedStatus,
                        reason: reason,     
                        comments: comments, 
                        lastUpdated: serverTimestamp()
                    }, { merge: true });
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'hospital_logs'), {
                        hospitalName, oldStatus: 'Unknown', newStatus: detectedStatus, timestamp: serverTimestamp(), rawText: text
                    });
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'system_logs'), {
                        message: `Simulator processed: ${hospitalName}`, type: 'success', timestamp: serverTimestamp()
                    });
                    document.getElementById('sim-textarea').value = '';
                } catch (e) { alert("Write Error: " + e.message); }
            } else {
                alert("Could not detect status. Try using 'to normal' or 'to diversion'.");
            }
            btn.innerHTML = `<i data-lucide="mail" class="w-4 h-4"></i> Process Email`;
            lucide.createIcons();
        };

        function formatTime(timestamp) {
            if (!timestamp) return 'Just now';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
        }

        function getStatusColor(status) {
            if (status === 'Normal') return 'bg-emerald-100 text-emerald-800 border-emerald-200';
            if (status === 'Diversion') return 'bg-rose-100 text-rose-800 border-rose-200';
            return 'bg-slate-100 text-slate-800 border-slate-200';
        }

        function renderDashboard() {
            if (state.hospitals.length === 0) return `<div class="text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300"><h3 class="text-lg font-medium text-slate-700">No Hospitals Tracked Yet</h3><p class="text-slate-500 mt-2">Go to <strong>Settings</strong> to define rules.</p></div>`;
            return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${state.hospitals.map(h => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition-shadow flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3">
                        <div class="px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1.5 border ${getStatusColor(h.status)}">
                            <i data-lucide="${h.status === 'Diversion' ? 'alert-triangle' : 'check-circle'}" class="w-4 h-4"></i>${h.status.toUpperCase()}
                        </div>
                        <button onclick="deleteHospital('${h.id}')" class="text-slate-400 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <h3 class="font-bold text-lg text-slate-900 mb-1">${h.name}</h3>
                    <p class="text-xs text-slate-400 mb-3 italic">Last updated: ${formatTime(h.lastUpdated)}</p>
                    
                    <div class="mt-auto space-y-2">
                        ${h.reason ? `
                            <div class="bg-slate-50 p-2 rounded border border-slate-100">
                                <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Reasons</span>
                                <p class="text-sm text-slate-800 leading-snug">${h.reason}</p>
                            </div>
                        ` : ''}
                        ${h.comments ? `
                            <div class="bg-slate-50 p-2 rounded border border-slate-100">
                                <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">Comments</span>
                                <p class="text-sm text-slate-800 leading-snug">${h.comments}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>`).join('')}</div>`;
        }

        function renderHistory() {
            if (state.logs.length === 0) return `<div class="p-8 text-center text-slate-500">No activity yet.</div>`;
            return `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden divide-y divide-slate-100">${state.logs.map(log => `
                <div class="p-4 flex items-start gap-4 hover:bg-slate-50">
                    <div class="mt-1 p-2 rounded-full ${log.newStatus === 'Diversion' ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'}"><i data-lucide="${log.newStatus === 'Diversion' ? 'alert-triangle' : 'check-circle'}" class="w-4 h-4"></i></div>
                    <div class="flex-1"><h4 class="font-medium text-slate-900">${log.hospitalName}</h4><p class="text-sm text-slate-600">Status changed to ${log.newStatus}</p></div>
                </div>`).join('')}</div>`;
        }

        function renderDebug() {
            if (state.systemLogs.length === 0) return `<div class="p-8 text-center text-slate-500">No system logs yet.</div>`;
            return `<div class="space-y-4"><div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-sm text-blue-700">Google Script Logs</div><div class="bg-slate-900 rounded-xl shadow-sm border border-slate-700 overflow-hidden text-slate-300 font-mono text-xs">${state.systemLogs.map(log => `
                <div class="p-3 border-b border-slate-700 flex gap-3 hover:bg-slate-800"><span class="text-slate-500 whitespace-nowrap">${formatTime(log.timestamp)}</span><span class="${log.type==='error'?'text-red-400':(log.type==='success'?'text-green-400':'text-blue-300')}">[${log.type?log.type.toUpperCase():'INFO'}]</span><span>${log.message}</span></div>`).join('')}</div></div>`;
        }
        
        function renderSettings() {
            return `
            <div class="max-w-4xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Add Rule</h3>
                    <div class="flex gap-4 items-end mb-4">
                        <div class="flex-1">
                            <input id="new-keyword" type="text" placeholder="KEYWORD (e.g. methodist)" class="w-full p-2 border border-slate-300 rounded-lg">
                        </div>
                        <div class="flex-1">
                            <input id="new-name" type="text" placeholder="DISPLAY NAME" class="w-full p-2 border border-slate-300 rounded-lg">
                        </div>
                        <button onclick="addMapping()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Add Rule</button>
                    </div>
                    <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer select-none">
                        <input type="checkbox" id="add-to-dash" checked class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                        Also add to Dashboard immediately (Status: Normal)
                    </label>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="divide-y divide-slate-100">
                        ${state.mappings.map(m => `
                            <div class="p-3 flex items-center text-sm">
                                <div class="flex-1 font-mono bg-slate-100 rounded px-2 py-1 w-fit text-slate-700">${m.keyword}</div>
                                <div class="flex-1 font-semibold text-slate-900">${m.displayName}</div>
                                <div class="w-20">
                                    <button onclick="deleteMapping('${m.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>`;
        }

        function renderSimulator() {
            return `<div class="max-w-2xl mx-auto space-y-6"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><textarea id="sim-textarea" class="w-full h-32 p-3 border border-slate-300 rounded-lg resize-none mb-4" placeholder="Alert Header\nMemorial Medical Center\nstatus from Limited Divert to Normal\nReasons: High Volume\nComments: ER is full"></textarea><div class="flex justify-between items-center"><div class="space-x-2 text-xs"><button onclick="setSimText('Alert Header\\nMemorial Medical Center\\nstatus from Limited Divert to Normal')" class="text-indigo-600 hover:underline">Insert "To Normal"</button></div><button id="process-btn" onclick="processEmail()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-md transition-all"><i data-lucide="mail" class="w-4 h-4"></i> Process Email</button></div></div></div>`;
        }
        
        function renderGuide() { return `<div class="max-w-3xl mx-auto space-y-8"><div><h2 class="text-2xl font-bold text-slate-800 mb-4">Integration Guide</h2></div><div class="bg-slate-900 rounded-xl overflow-hidden p-6 text-slate-50 font-mono text-xs overflow-x-auto"><pre>Use Code.gs provided in chat.</pre></div></div>`; }

        function render() {
            const root = document.getElementById('root');
            if (state.error) { root.innerHTML = `<div class="p-8 text-center text-red-600 font-bold">${state.error}</div>`; return; }
            if (state.loading) { root.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-slate-50 text-indigo-600"><i data-lucide="refresh-cw" class="w-8 h-8 animate-spin"></i></div>`; lucide.createIcons(); return; }
            const getTabClass = (name) => `w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors ${state.activeTab === name ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-50'}`;
            root.innerHTML = `<div class="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col md:flex-row"><div class="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col"><div class="p-6 border-b border-slate-100"><div class="flex items-center gap-2 text-indigo-600 mb-1"><i data-lucide="activity" class="w-6 h-6"></i><span class="font-bold text-xl tracking-tight">MediTrack</span></div></div><nav class="flex-1 p-4 space-y-2"><button onclick="setTab('dashboard')" class="${getTabClass('dashboard')}"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</button><button onclick="setTab('history')" class="${getTabClass('history')}"><i data-lucide="history" class="w-5 h-5"></i> History Log</button><button onclick="setTab('settings')" class="${getTabClass('settings')}"><i data-lucide="settings" class="w-5 h-5"></i> Settings</button><button onclick="setTab('debug')" class="${getTabClass('debug')}"><i data-lucide="terminal" class="w-5 h-5"></i> Debug Console</button><div class="pt-4 pb-2 px-4 text-xs font-semibold text-slate-400 uppercase">Admin Tools</div><button onclick="setTab('simulator')" class="${getTabClass('simulator')}"><i data-lucide="play-circle" class="w-5 h-5"></i> Email Simulator</button><button onclick="setTab('guide')" class="${getTabClass('guide')}"><i data-lucide="mail" class="w-5 h-5"></i> Setup Guide</button></nav></div><div class="flex-1 overflow-y-auto"><header class="bg-white border-b border-slate-200 px-8 py-4 sticky top-0 z-10"><h1 class="text-xl font-bold text-slate-800 capitalize">${state.activeTab === 'debug' ? 'System Debug Logs' : state.activeTab}</h1></header><main class="p-8">${state.activeTab === 'dashboard' ? renderDashboard() : ''}${state.activeTab === 'history' ? renderHistory() : ''}${state.activeTab === 'settings' ? renderSettings() : ''}${state.activeTab === 'debug' ? renderDebug() : ''}${state.activeTab === 'simulator' ? renderSimulator() : ''}${state.activeTab === 'guide' ? renderGuide() : ''}</main></div></div>`;
            lucide.createIcons();
        }
        render();
    </script>
</head>
<body><div id="root"></div></body>
</html>