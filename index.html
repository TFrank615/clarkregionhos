<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Status Board</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const state = {
            hospitals: [],
            logs: [],
            loading: true,
            error: null
        };

        // --- Shared Configuration (Same as your main app) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuO1PsUAsMf0OsaK78P9pnnnfHDUXB3bE",
            authDomain: "hospital-tracker-e0e23.firebaseapp.com",
            projectId: "hospital-tracker-e0e23",
            storageBucket: "hospital-tracker-e0e23.firebasestorage.app",
            messagingSenderId: "71333986582",
            appId: "1:71333986582:web:b9d1539554138752199037",
            measurementId: "G-7HP9NE801M"
        };
        
        const appId = 'default-app-id'; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Auth & Init ---
        async function init() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                state.error = "Connection Failed";
                render();
            }
        }
        init();

        onAuthStateChanged(auth, (user) => {
            if (user) setupListeners();
        });

        function setupListeners() {
            // 1. Hospitals (Public Data)
            const hospitalsRef = collection(db, 'artifacts', appId, 'public', 'data', 'hospitals');
            onSnapshot(hospitalsRef, (snapshot) => {
                state.hospitals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by status (Diversion first) then name
                state.hospitals.sort((a, b) => {
                    if (a.status === 'Diversion' && b.status !== 'Diversion') return -1;
                    if (a.status !== 'Diversion' && b.status === 'Diversion') return 1;
                    return a.name.localeCompare(b.name);
                });
                state.loading = false;
                render();
            }, (error) => {
                console.error(error);
                state.error = "Data Sync Error";
                render();
            });

            // 2. Recent Activity Log (Optional ticker)
            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'hospital_logs');
            const qLogs = query(logsRef, orderBy('timestamp', 'desc'), limit(5));
            onSnapshot(qLogs, (snapshot) => {
                state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        // --- Helper Functions ---
        function formatTime(timestamp) {
            if (!timestamp) return '--:--';
            const date = new Date(timestamp.seconds * 1000);
            // Updated to force 24-hour format (hour12: false)
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) + ' ' + date.toLocaleDateString();
        }

        function getStatusStyles(status) {
            if (status === 'Normal') return {
                card: 'bg-white border-emerald-500 border-l-8',
                badge: 'bg-emerald-100 text-emerald-800',
                icon: 'check-circle'
            };
            if (status === 'Diversion') return {
                card: 'bg-rose-50 border-rose-600 border-l-8 shadow-md', // Highlight diversion more
                badge: 'bg-rose-600 text-white',
                icon: 'alert-triangle'
            };
            return {
                card: 'bg-slate-50 border-slate-300 border-l-8',
                badge: 'bg-slate-200 text-slate-700',
                icon: 'help-circle'
            };
        }

        // --- Render Logic ---
        function render() {
            const root = document.getElementById('root');
            
            if (state.error) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-slate-900 text-red-500 font-bold text-2xl">
                        <i data-lucide="wifi-off" class="w-8 h-8 mr-3"></i> ${state.error}
                    </div>`;
                lucide.createIcons();
                return;
            }

            if (state.loading) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-slate-900 text-slate-400">
                        <i data-lucide="refresh-cw" class="w-12 h-12 animate-spin"></i>
                    </div>`;
                lucide.createIcons();
                return;
            }

            const diversionCount = state.hospitals.filter(h => h.status === 'Diversion').length;

            root.innerHTML = `
                <div class="min-h-screen bg-slate-100 font-sans text-slate-900 flex flex-col overflow-hidden">
                    <!-- Header Bar -->
                    <header class="bg-slate-900 text-white p-6 shadow-lg z-10 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="bg-indigo-600 p-3 rounded-lg">
                                <i data-lucide="activity" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold tracking-tight">Regional Hospital Status</h1>
                                <div class="flex items-center gap-2 text-slate-400 text-sm mt-1">
                                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    System Live
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Stats Bar -->
                    <div class="bg-white border-b border-slate-200 px-8 py-3 flex items-center gap-8 shadow-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm uppercase font-bold">Total Tracked:</span>
                            <span class="text-xl font-bold text-slate-800">${state.hospitals.length}</span>
                        </div>
                        <div class="h-6 w-px bg-slate-200"></div>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm uppercase font-bold">On Diversion:</span>
                            <span class="text-xl font-bold ${diversionCount > 0 ? 'text-rose-600' : 'text-emerald-600'}">${diversionCount}</span>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <main class="flex-1 p-6 overflow-y-auto h-full">
                        ${state.hospitals.length === 0 ? `
                            <div class="h-full flex flex-col items-center justify-center text-slate-400">
                                <i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-50"></i>
                                <p class="text-xl">Waiting for hospital data...</p>
                            </div>
                        ` : `
                            <!-- Reverted to fixed large columns, added larger text classes -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 h-full content-start">
                                ${state.hospitals.map(h => {
                                    const styles = getStatusStyles(h.status);
                                    return `
                                    <div class="${styles.card} rounded-xl shadow-sm p-6 flex flex-col transition-all h-full">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1 pr-2">
                                                <!-- Increased Text Size: text-3xl -->
                                                <h2 class="text-3xl font-bold text-slate-900 leading-tight">${h.name}</h2>
                                                <!-- Increased Text Size: text-sm -->
                                                <p class="text-sm text-slate-400 mt-2 font-medium">Updated: ${formatTime(h.lastUpdated)}</p>
                                            </div>
                                            <!-- Increased Badge Size -->
                                            <div class="${styles.badge} px-4 py-2 rounded-full text-base font-bold flex items-center gap-2 shadow-sm shrink-0">
                                                <i data-lucide="${styles.icon}" class="w-5 h-5"></i>
                                                ${h.status.toUpperCase()}
                                            </div>
                                        </div>
                                        
                                        <div class="mt-auto space-y-4">
                                            ${h.reason ? `
                                                <div class="bg-slate-100/80 p-4 rounded border border-slate-200">
                                                    <!-- Increased Label Size -->
                                                    <span class="text-sm font-bold text-slate-500 uppercase tracking-wide block mb-1">REASONS</span>
                                                    <!-- Increased Body Size: text-xl -->
                                                    <p class="text-xl font-medium text-slate-800 uppercase leading-snug">${h.reason}</p>
                                                </div>
                                            ` : ''}
                                            ${h.comments ? `
                                                <div class="bg-slate-100/80 p-4 rounded border border-slate-200">
                                                    <!-- Increased Label Size -->
                                                    <span class="text-sm font-bold text-slate-500 uppercase tracking-wide block mb-1">COMMENTS</span>
                                                    <!-- Increased Body Size: text-lg -->
                                                    <p class="text-lg text-slate-700 uppercase leading-snug">${h.comments}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </main>

                    <!-- Bottom Ticker (Recent Changes) -->
                    <footer class="bg-slate-800 text-slate-300 px-6 py-3 text-base flex items-center gap-4 whitespace-nowrap overflow-hidden">
                        <span class="font-bold text-indigo-400">LATEST UPDATES:</span>
                        <div class="flex gap-8 animate-marquee">
                            ${state.logs.length > 0 ? state.logs.map(l => `
                                <span class="flex items-center gap-2">
                                    <i data-lucide="clock" class="w-4 h-4"></i> ${formatTime(l.timestamp)}: 
                                    <strong class="text-white">${l.hospitalName}</strong> â†’ 
                                    <span class="${l.newStatus === 'Diversion' ? 'text-rose-400' : 'text-emerald-400'}">${l.newStatus}</span>
                                </span>
                            `).join('<span class="text-slate-600 mx-2">|</span>') : 'No recent updates.'}
                        </div>
                    </footer>
                </div>
            `;
            
            lucide.createIcons();
        }

        // Initial Render
        render();
    </script>
</head>
<body>
    <div id="root"></div>
</body>
</html>